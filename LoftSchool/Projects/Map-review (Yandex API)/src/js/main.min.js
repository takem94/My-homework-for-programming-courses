!function a(i,l,s){function u(t,e){if(!l[t]){if(!i[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(c)return c(t,!0);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}var o=l[t]={exports:{}};i[t][0].call(o.exports,function(e){return u(i[t][1][e]||e)},o,o.exports,a,i,l,s)}return l[t].exports}for(var c="function"==typeof require&&require,e=0;e<s.length;e++)u(s[e]);return u}({1:[function(e,t,r){t.exports=function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}},{}],2:[function(e,t,r){function s(e,t,r,n,o,a,i){try{var l=e[a](i),s=l.value}catch(e){return void r(e)}l.done?t(s):Promise.resolve(s).then(n,o)}t.exports=function(l){return function(){var e=this,i=arguments;return new Promise(function(t,r){var n=l.apply(e,i);function o(e){s(n,t,r,o,a,"next",e)}function a(e){s(n,t,r,o,a,"throw",e)}o(void 0)})}}},{}],3:[function(e,t,r){t.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],4:[function(e,t,r){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}t.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},{}],5:[function(e,t,r){t.exports=function(e){return e&&e.__esModule?e:{default:e}}},{}],6:[function(e,t,r){t.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},{}],7:[function(e,t,r){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},{}],8:[function(e,t,r){var n=e("./arrayWithoutHoles"),o=e("./iterableToArray"),a=e("./nonIterableSpread");t.exports=function(e){return n(e)||o(e)||a()}},{"./arrayWithoutHoles":1,"./iterableToArray":6,"./nonIterableSpread":7}],9:[function(e,t,r){var n=function(){return this||"object"==typeof self&&self}()||Function("return this")(),o=n.regeneratorRuntime&&0<=Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime"),a=o&&n.regeneratorRuntime;if(n.regeneratorRuntime=void 0,t.exports=e("./runtime"),o)n.regeneratorRuntime=a;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}},{"./runtime":10}],10:[function(e,A,t){!function(e){"use strict";var s,t=Object.prototype,u=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",n=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag",i="object"==typeof A,l=e.regeneratorRuntime;if(l)i&&(A.exports=l);else{(l=e.regeneratorRuntime=i?A.exports:{}).wrap=w;var h="suspendedStart",d="suspendedYield",p="executing",f="completed",m={},c={};c[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(S([])));y&&y!==t&&u.call(y,o)&&(c=y);var g=k.prototype=M.prototype=Object.create(c);C.prototype=g.constructor=k,k.constructor=C,k[a]=C.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===C||"GeneratorFunction"===(t.displayName||t.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,k):(e.__proto__=k,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(g),e},l.awrap=function(e){return{__await:e}},E(D.prototype),D.prototype[n]=function(){return this},l.AsyncIterator=D,l.async=function(e,t,r,n){var o=new D(w(e,t,r,n));return l.isGeneratorFunction(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},E(g),g[a]="Generator",g[o]=function(){return this},g.toString=function(){return"[object Generator]"},l.keys=function(r){var n=[];for(var e in r)n.push(e);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},l.values=S,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=s,this.done=!1,this.delegate=null,this.method="next",this.arg=s,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&u.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=s)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function e(e,t){return a.type="throw",a.arg=r,n.next=e,t&&(n.method="next",n.arg=s),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var o=this.tryEntries[t],a=o.completion;if("root"===o.tryLoc)return e("end");if(o.tryLoc<=this.prev){var i=u.call(o,"catchLoc"),l=u.call(o,"finallyLoc");if(i&&l){if(this.prev<o.catchLoc)return e(o.catchLoc,!0);if(this.prev<o.finallyLoc)return e(o.finallyLoc)}else if(i){if(this.prev<o.catchLoc)return e(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return e(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&u.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;O(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=s),m}}}function w(e,t,r,n){var a,i,l,s,o=t&&t.prototype instanceof M?t:M,u=Object.create(o.prototype),c=new _(n||[]);return u._invoke=(a=e,i=r,l=c,s=h,function(e,t){if(s===p)throw new Error("Generator is already running");if(s===f){if("throw"===e)throw t;return V()}for(l.method=e,l.arg=t;;){var r=l.delegate;if(r){var n=L(r,l);if(n){if(n===m)continue;return n}}if("next"===l.method)l.sent=l._sent=l.arg;else if("throw"===l.method){if(s===h)throw s=f,l.arg;l.dispatchException(l.arg)}else"return"===l.method&&l.abrupt("return",l.arg);s=p;var o=b(a,i,l);if("normal"===o.type){if(s=l.done?f:d,o.arg===m)continue;return{value:o.arg,done:l.done}}"throw"===o.type&&(s=f,l.method="throw",l.arg=o.arg)}}),u}function b(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function M(){}function C(){}function k(){}function E(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function D(s){var t;this._invoke=function(r,n){function e(){return new Promise(function(e,t){!function t(e,r,n,o){var a=b(s[e],s,r);if("throw"!==a.type){var i=a.arg,l=i.value;return l&&"object"==typeof l&&u.call(l,"__await")?Promise.resolve(l.__await).then(function(e){t("next",e,n,o)},function(e){t("throw",e,n,o)}):Promise.resolve(l).then(function(e){i.value=e,n(i)},function(e){return t("throw",e,n,o)})}o(a.arg)}(r,n,e,t)})}return t=t?t.then(e,e):e()}}function L(e,t){var r=e.iterator[t.method];if(r===s){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=s,L(e,t),"throw"===t.method))return m;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var n=b(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,m;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=s),t.delegate=null,m):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,m)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,n=function e(){for(;++r<t.length;)if(u.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=s,e.done=!0,e};return n.next=n}}return{next:V}}function V(){return{value:s,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())},{}],11:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":9}],12:[function(e,t,r){"use strict";var n=e("./modules/ControllerMap");window.addEventListener("DOMContentLoaded",function(){var e=new n.ControllerMap;e.init().then(function(){e.initListeners(),e.initData()})})},{"./modules/ControllerMap":13}],13:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.ControllerMap=void 0;var o=n(e("@babel/runtime/regenerator")),a=n(e("@babel/runtime/helpers/toConsumableArray")),i=n(e("@babel/runtime/helpers/asyncToGenerator")),l=n(e("@babel/runtime/helpers/classCallCheck")),s=n(e("@babel/runtime/helpers/createClass")),u=e("./ModelMap"),c=e("./ViewMap"),h=function(){function e(){(0,l.default)(this,e),this.data=null,this.ModelMap=new u.ModelMap,this.ViewMap=new c.ViewMap}var t;return(0,s.default)(e,[{key:"init",value:function(){var t=this;return new Promise(function(e){t.ViewMap.initYmap().then(function(){t.ViewMap.init(t.ModelMap.createMap())}).then(function(){t.ModelMap.createClusterer(t.ViewMap.getClustererContentLayout()),t.ModelMap.addClusterer(t.ViewMap.map),e()})})}},{key:"initListeners",value:function(){this.ViewMap.setEvenOnYmapClick(this.ViewMap.map,this.onMapClick.bind(this)),this.ViewMap.setEventOnElemClick(this.ViewMap.modalCloseBtn,this.onModalCloseClick.bind(this)),this.ViewMap.setEventOnElemClick(this.ViewMap.formAddBtn,this.onReviewAdd.bind(this)),this.ViewMap.setEvenOnYmapClick(this.ModelMap.clusterer,this.onClusterClick.bind(this)),this.ViewMap.setEventOnElemClick("",this.onLinkBalloonClick.bind(this)),this.ViewMap.setEventOnElemClick("#saveDataBtn",this.onSaveClick.bind(this)),this.ViewMap.setEventOnElemClick("#delDataBtn",this.onDelClick.bind(this))}},{key:"initData",value:function(){var t=this;this.ModelMap.getSavedData().forEach(function(e){t.ModelMap.addCluster(t.ViewMap.getPointData(e),e.coords)})}},{key:"onMapClick",value:(t=(0,i.default)(o.default.mark(function e(t){var r,n;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.ViewMap.modalStatus)return e.abrupt("return",null);e.next=2;break;case 2:return e.prev=2,e.next=5,this.ModelMap.getGeoAddress(this.ModelMap.getGeoCoordsFromEvent(t));case 5:n=e.sent,this.ViewMap.closeAllBallons(this.ModelMap.clusterer),this.ViewMap.changeAddress(n),(r=this.ViewMap).changeModalPosition.apply(r,(0,a.default)(t.get("clientPixels"))),this.ViewMap.renderReviews(),this.ViewMap.changeModalState("disable","remove",!0),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("Ошибка при обработке клика."),console.error(e.t0.message);case 17:case"end":return e.stop()}},e,this,[[2,13]])})),function(e){return t.apply(this,arguments)})},{key:"onSaveClick",value:function(){this.ModelMap.saveData()}},{key:"onDelClick",value:function(){this.ModelMap.cleanData()}},{key:"onModalCloseClick",value:function(){this.ViewMap.changeModalState("enable","add",!1)}},{key:"onReviewAdd",value:function(){var e=this.ModelMap.getDataFromForm(this.ViewMap.inputList);this.ModelMap.addCluster(this.ViewMap.getPointData(e)),this.ViewMap.renderReview(e),this.ModelMap.saveData()}},{key:"onClusterClick",value:function(e){this.ViewMap.changeModalState("enable","add",!1);var t=this.ModelMap.getGeoObjectsFromEvent(e);this.ModelMap.getDataFromGeoObjects(t)}},{key:"onLinkBalloonClick",value:function(e){e.target.classList.contains("ballon-link")&&(e.preventDefault(),this.ModelMap.filterDataByCoords(parseInt(e.target.dataset.idCluster)),this.ViewMap.closeAllBallons(this.ModelMap.clusterer),this.ViewMap.renderReviews({items:this.ModelMap.lastData}),this.ViewMap.changeAddress(this.ModelMap.lastAddress),this.ViewMap.changeModalPosition(e.pageX,e.pageY),this.ViewMap.changeModalState("disable","remove",!0))}}]),e}();r.ControllerMap=h},{"./ModelMap":14,"./ViewMap":15,"@babel/runtime/helpers/asyncToGenerator":2,"@babel/runtime/helpers/classCallCheck":3,"@babel/runtime/helpers/createClass":4,"@babel/runtime/helpers/interopRequireDefault":5,"@babel/runtime/helpers/toConsumableArray":8,"@babel/runtime/regenerator":11}],14:[function(a,e,i){(function(n){"use strict";var e=a("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(i,"__esModule",{value:!0}),i.ModelMap=void 0;var t=e(a("@babel/runtime/helpers/classCallCheck")),r=e(a("@babel/runtime/helpers/createClass")),o=function(){function e(){(0,t.default)(this,e),this.clusterer=null,this.lastCoords=null,this.lastAddress=null,this.lastData=null}return(0,r.default)(e,[{key:"createMap",value:function(){return new n.ymaps.Map("map",{center:[55.76,37.64],zoom:10,behaviors:["default","scrollZoom"],controls:[]})}},{key:"createClusterer",value:function(e){return this.clusterer=new n.ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:e,clusterBalloonPanelMaxMapArea:0,groupByCoordinates:!1,clusterDisableClickZoom:!0,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,clusterBalloonPagerSize:5,clusterBalloonContentLayoutHeight:250,clusterBalloonContentLayoutWidth:250,gridSize:80}),this.clusterer}},{key:"addClusterer",value:function(e){e.geoObjects.add(this.clusterer)}},{key:"addCluster",value:function(e,t){t=t||this.lastCoords,this.clusterer.add(new n.ymaps.Placemark(t,e,this.getPointOptions()))}},{key:"getDataFromForm",value:function(e){var t=0,r=new Date,n={time:r.toLocaleDateString()+" "+r.toLocaleTimeString(),address:this.lastAddress,coords:this.lastCoords};if(e.forEach(function(e){2<e.value.length&&(n[e.name]=e.value,t++)}),t===e.length)return e.forEach(function(e){e.value=""}),n;window.alert("Заполните все поля!")}},{key:"getPointOptions",value:function(){return{preset:"islands#violetIcon"}}},{key:"getGeoObjectsFromEvent",value:function(e){this.lastData=e.get("target");var t=this.lastData.properties.get("geoObjects");return this.lastData=t||[this.lastData],this.lastData}},{key:"getDataFromGeoObjects",value:function(e){for(var t=[],r=0;r<e.length;++r)t.push(e[r].properties.get("clusterData"));return this.lastData=t,this.lastData}},{key:"getGeoCoordsFromEvent",value:function(e){return this.lastCoords=e.get("coords"),this.lastCoords}},{key:"getGeoAddress",value:function(e){var r=this;return new Promise(function(t){n.ymaps.geocode(e).then(function(e){r.lastAddress=e.geoObjects.get(0).properties.get("text"),t(r.lastAddress)})})}},{key:"filterDataByCoords",value:function(e){for(var t,r,n=this.lastData,o=[],a=0;a<this.lastData.length;++a)r||n[a].id!==e||(r=n[a].address,t=n[a].coords,a=0),t&&t[0]===n[a].coords[0]&&t[1]===n[a].coords[1]&&o.push(n[a]);return this.lastData=o,r&&t&&(this.lastAddress=r,this.lastCoords=t),this.lastData}},{key:"saveData",value:function(){var e=this.lastData,t=this.clusterer.getGeoObjects();this.getDataFromGeoObjects(t),n.localStorage.mapBalloonsData=JSON.stringify(this.lastData),this.lastData=e}},{key:"cleanData",value:function(){n.localStorage.mapBalloonsData="",this.clusterer.removeAll()}},{key:"getSavedData",value:function(){return n.localStorage.mapBalloonsData?JSON.parse(n.localStorage.mapBalloonsData):[]}}]),e}();i.ModelMap=o}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"@babel/runtime/helpers/classCallCheck":3,"@babel/runtime/helpers/createClass":4,"@babel/runtime/helpers/interopRequireDefault":5}],15:[function(a,e,i){(function(t){"use strict";var e=a("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(i,"__esModule",{value:!0}),i.ViewMap=void 0;var r=e(a("@babel/runtime/helpers/classCallCheck")),n=e(a("@babel/runtime/helpers/createClass")),o=function(){function e(){(0,r.default)(this,e),this.modalStatus=!1,this.idCounter=0,this.modalElem=null,this.modalCloseBtn=null,this.modalAddress=null,this.formAddBtn=null,this.inputList=null,this.map=null,this._reviewContainer=null,this._reviewsTemplate=null}return(0,n.default)(e,[{key:"init",value:function(e){this.map=e,this.createModalTemplate(),this.createReviewsTemplate()}},{key:"initYmap",value:function(){return new Promise(function(e){t.ymaps.ready(e)})}},{key:"createModalTemplate",value:function(){var e=document.querySelector("#modalTemplate");e=t.Handlebars.compile(e.innerHTML),this.modalElem=document.querySelector("#modal"),this.modalElem.innerHTML+=e(),this.modalElem=this.modalElem.firstElementChild,this.inputList=this.modalElem.querySelectorAll("input, textarea"),this.formAddBtn=this.modalElem.querySelector(".review-modal__body-form-btn"),this.modalCloseBtn=this.modalElem.querySelector(".review-modal__header-close"),this.modalAddress=this.modalElem.querySelector("#modalAddress"),this._reviewContainer=this.modalElem.querySelector(".reviews-list__container")}},{key:"createReviewsTemplate",value:function(){this._reviewsTemplate=document.querySelector("#reviewListTemplate"),this._reviewsTemplate=t.Handlebars.compile(this._reviewsTemplate.innerHTML)}},{key:"renderReviews",value:function(e){this._reviewContainer.innerHTML=this._reviewsTemplate(e),this.scrollReviewsToBottom()}},{key:"renderReview",value:function(e){this._reviewContainer.querySelector(".reviews-list__empty")?this.renderReviews({items:[e]}):(this._reviewContainer.innerHTML+=this._reviewsTemplate({items:[e]}),this.scrollReviewsToBottom())}},{key:"getClustererContentLayout",value:function(){return t.ymaps.templateLayoutFactory.createClass("<h2 class=ballon_header>{{ properties.balloonContentHeader|raw }}</h2><div class=ballon_body>{{ properties.balloonContentBody|raw }}</div><div class=ballon_footer>{{ properties.balloonContentFooter|raw }}</div>")}},{key:"getPointData",value:function(e){return e.id=this.idCounter,{balloonContentHeader:"<font size=3><b>".concat(e.place,"</b></font>"),balloonContentBody:'<p style="margin: 0;"><a href="#" data-id-cluster="'.concat(this.idCounter++,'" class="ballon-link">').concat(e.address,"</a></p><br>")+'<p style="margin: 0; word-break: break-word;">'.concat(e.message,"</p>"),balloonContentFooter:'<font size=2><div style="position: relative; height: 18px;"><span style="position: absolute; right: 0;">'.concat(e.time,"</span></div></font>"),clusterData:e}}},{key:"scrollReviewsToBottom",value:function(){this._reviewContainer.parentElement.scrollTop=this._reviewContainer.parentElement.scrollHeight}},{key:"setEventOnElemClick",value:function(e,t){""===e?e=document.body:"string"==typeof e&&0<e.length&&(e=document.querySelector(e)),e.addEventListener("click",t)}},{key:"setEvenOnYmapClick",value:function(e,t){e.events.add("click",t)}},{key:"changeAddress",value:function(e){this.modalAddress.innerText=e}},{key:"changeMapBehavior",value:function(e){this.map.behaviors[e](["drag","scrollZoom","dblClickZoom"])}},{key:"changeModalState",value:function(e,t,r){this.modalStatus!==r&&(this.changeMapBehavior(e),this.modalElem.classList[t]("hide"),this.modalStatus=r)}},{key:"changeModalPosition",value:function(e,t){var r=this.modalElem,n=r.clientHeight+t,o=r.clientWidth+e;o=o>window.innerWidth?window.innerWidth-r.clientWidth-10:e,n=n>window.innerHeight?window.innerHeight-r.clientHeight-10:t,r.style.left=o+"px",r.style.top=n+"px"}},{key:"closeAllBallons",value:function(e){this.map.balloon.close(),e.balloon.close()}}]),e}();i.ViewMap=o}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"@babel/runtime/helpers/classCallCheck":3,"@babel/runtime/helpers/createClass":4,"@babel/runtime/helpers/interopRequireDefault":5}]},{},[12]);